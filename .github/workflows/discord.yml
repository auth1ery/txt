name: discord commit notifier

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: verify secret
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "error: DISCORD_WEBHOOK secret is empty"
            exit 1
          fi

      - name: send commit to discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s | sed 's/"/\\"/g')
          AUTHOR=$(git log -1 --pretty=%an)
          REPO="${{ github.repository }}"
          SHA="${{ github.sha }}"
          URL="https://github.com/${REPO}/commit/${SHA}"

          curl -H "Content-Type: application/json" \
            -d "{
              \"username\": \"github\",
              \"embeds\": [
                {
                  \"title\": \"new commit!\",
                  \"description\": \"${COMMIT_MSG}\",
                  \"url\": \"${URL}\",
                  \"color\": 5793266,
                  \"footer\": { \"text\": \"${REPO} â€¢ ${AUTHOR}\" }
                }
              ]
            }" \
            $WEBHOOK
