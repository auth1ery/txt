<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>txt</title>
<style>
body{margin:0;font-family:system-ui,sans-serif;background:#0f0f0f;color:#eaeaea;display:flex;align-items:center;justify-content:center;min-height:100vh}
#container{max-width:500px;padding:2rem;text-align:center}
h2{font-size:2rem;margin:0 0 1rem 0;letter-spacing:-1px}
p{color:#aaa;line-height:1.6;margin:1.5rem 0}
.user-badge{background:#1a1a1a;border:1px solid #333;padding:1rem;border-radius:8px;margin:1.5rem 0;display:inline-block}
.user-badge strong{color:#888}
button{background:#222;color:#aaa;border:1px solid #333;padding:0.75rem 2rem;border-radius:4px;cursor:pointer;font-size:1rem;margin-top:1rem}
button:hover{background:#2a2a2a;border-color:#444;color:#eaeaea}
button:disabled{background:#1a1a1a;cursor:not-allowed;color:#555}
button.create-account{background:#222;border-color:#333}
button.create-account:hover{background:#2a2a2a;border-color:#444}
.error{color:#c44;margin-top:1rem}
.success{color:#888;margin-top:1rem}
.warning{color:#999;margin-top:1rem}
.loading{color:#666;font-style:italic}
</style>
</head>
<body>
<div id="container">
<h2>verify with auth's RNG</h2>
<div id="content">
  <p class="loading">checking your login status...</p>
</div>
</div>
<script>
const urlParams = new URLSearchParams(window.location.search)
const token = urlParams.get("token")
const contentEl = document.getElementById("content")

// Debug logging
console.log("Token from URL:", token)
console.log("Token length:", token ? token.length : 0)

async function checkLogin() {
  const nickname = localStorage.getItem("nickname")
  console.log("Nickname from localStorage:", nickname)
  
  if(!token) {
    contentEl.innerHTML = '<p class="error">Error: No token provided</p><p>Please try linking again from auth\'s RNG.</p>'
    return
  }
  
  if(!nickname) {
    // Not logged in
    contentEl.innerHTML = '<div class="user-badge">signed in as: <strong>nobody</strong></div><p class="warning">you need a txt account to link with auth\'s RNG.</p><button class="create-account" onclick="window.location.href=\'/\'">create account / login</button>'
  } else {
    // Logged in - verify user exists
    try {
      const profileRes = await fetch('/api/profile/' + nickname)
      
      if(!profileRes.ok) {
        // User doesn't exist anymore
        localStorage.removeItem("nickname")
        contentEl.innerHTML = '<div class="user-badge">signed in as: <strong>nobody</strong></div><p class="warning">your account no longer exists. please create a new one.</p><button class="create-account" onclick="window.location.href=\'/\'">create account / login</button>'
        return
      }
      
      const profile = await profileRes.json()
      console.log("Profile data:", profile)
      
      // Check if already linked
      if(profile.rngLinked) {
        contentEl.innerHTML = '<div class="user-badge">signed in as: <strong>' + nickname + '</strong></div><p class="success">your account is already linked with auth\'s RNG!</p><button onclick="window.location.href=\'https://authsrng.neocities.org\'">return</button>'
        return
      }
      
      // Show confirmation
      contentEl.innerHTML = '<div class="user-badge">signed in as: <strong>' + nickname + '</strong></div><p>click the button below to confirm linking with auth\'s RNG.</p><button id="confirm-link">confirm link</button><div id="message"></div>'
      
      document.getElementById("confirm-link").addEventListener("click", handleLink)
      
    } catch(e) {
      console.error(e)
      contentEl.innerHTML = '<p class="error">Error checking account status</p><button onclick="location.reload()">try again</button>'
    }
  }
}

async function handleLink() {
  const nickname = localStorage.getItem("nickname")
  const button = document.getElementById("confirm-link")
  const messageEl = document.getElementById("message")
  
  console.log("Attempting link with:", { nickname: nickname, token: token })
  
  button.disabled = true
  button.textContent = "linking..."
  messageEl.textContent = ""
  
  try {
    const res = await fetch("/api/rng-link", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ nickname: nickname, token: token })
    })
    
    console.log("Response status:", res.status)
    
    let data = {}
    try {
      data = await res.json()
      console.log("Response data:", data)
    } catch(e) {
      console.log("No JSON response")
    }
    
    if(res.ok) {
      messageEl.textContent = "txt > auth's RNG linked successfully! Redirecting..."
      messageEl.className = "success"
      setTimeout(function() {
        window.location.href = "https://authsrng.neocities.org"
      }, 1500)
    } else {
      messageEl.textContent = data.error || "Error linking account (status: " + res.status + ")"
      messageEl.className = "error"
      button.disabled = false
      button.textContent = "confirm link"
    }
  } catch(e) {
    console.error("Network error:", e)
    messageEl.textContent = "Network error. Please try again."
    messageEl.className = "error"
    button.disabled = false
    button.textContent = "confirm link"
  }
}

checkLogin()
</script>
</body>
</html>
