<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>profile - txt</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@1/web/uc-file-uploader-regular.min.css">
<style>
body{margin:0;font-family:system-ui,sans-serif;background:#0f0f0f;color:#eaeaea}
#app{max-width:600px;margin:auto;padding:1rem}
.profile-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
.profile-info h2{margin:0}
.profile-stats{display:flex;gap:1rem;margin:.5rem 0;font-size:.9rem;color:#777}
.profile-stats a{color:#777;text-decoration:none}
.profile-stats a:hover{color:#fff}
.profile-meta{color:#777;font-size:.85rem;margin:.3rem 0}
.profile-bio{margin:1rem 0;color:#aaa}
button{padding:.4rem .8rem;margin:.2rem;border:1px solid #555;border-radius:.25rem;background:none;color:#aaa;cursor:pointer}
button:hover{border-color:#eaeaea;color:#fff}
#follow-btn.following{border-color:#4c4;color:#4c4}
a{color:#777;text-decoration:none}
a:hover{color:#fff}
.back-btn{margin-bottom:1rem}
.section{margin:2rem 0}
.section h3{margin-bottom:1rem;color:#eaeaea}
.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
.stat-card{border:1px solid #222;border-radius:.5rem;padding:1rem;text-align:center}
.stat-value{font-size:1.5rem;color:#eaeaea;font-weight:bold}
.stat-label{font-size:.85rem;color:#777;margin-top:.3rem}
.rss-link{margin-top:1rem;text-align:center}
.rss-link a{color:#f80;text-decoration:none;font-size:.9rem}
.rss-link a:hover{color:#fa0}
.activity-card{border:1px solid #222;border-radius:.5rem;padding:1rem}
.activity-status{color:#777;font-size:.85rem}
.activity-status.online{color:#4c4}
.activity-content{color:#eaeaea;margin-top:.5rem;font-size:.95rem}
.activity-platform{color:#888;font-size:.8rem;margin-top:.3rem}
.hidden{display:none}
.guestbook-section{margin:2rem 0}
.guestbook-form{border:1px solid var(--accent-color,#4c4);border-radius:.5rem;padding:1rem;margin-bottom:1rem}
.gb-entry{border-bottom:1px solid #222;padding:1rem 0}
.gb-entry:last-child{border-bottom:none}
.gb-meta{font-size:.8rem;color:#777;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
.gb-media{max-width:100%;margin:.5rem 0;border-radius:.5rem}
.gb-media img,.gb-media video{max-width:100%;border-radius:.5rem}
.gb-media audio{width:100%}
textarea{width:100%;background:#0f0f0f;color:#eaeaea;border:1px solid #222;padding:.5rem;margin:.3rem 0;box-sizing:border-box;font-family:system-ui,sans-serif}
uc-file-uploader-regular{display:none}
</style>
</head>
<body>
<div id="app">
<button class="back-btn" onclick="location.href='/feed'">‚Üê back to feed</button>
<div class="profile-header">
  <div class="profile-info">
    <h2 id="username"></h2>
    <div class="profile-stats">
      <a href="#" onclick="showFollowers(); return false"><span id="follower-count">0</span> followers</a>
      <a href="#" onclick="showFollowing(); return false"><span id="following-count">0</span> following</a>
    </div>
    <div class="profile-meta">
      <span id="pronouns"></span>
      <span id="timezone"></span>
    </div>
    <div class="profile-bio" id="bio"></div>
    <div class="rss-link">
      <a href="#" onclick="copyRSS(); return false" title="copy rss feed url">üì° rss feed</a>
    </div>
  </div>
  <div>
    <button id="follow-btn" class="hidden" onclick="toggleFollow()">follow</button>
    <button id="edit-btn" class="hidden" onclick="location.href='/settings'">edit profile</button>
  </div>
</div>

<div class="section">
  <h3>activity</h3>
  <div class="activity-card">
    <div class="activity-status" id="activity-status">offline</div>
    <div class="activity-content" id="activity-content"></div>
    <div class="activity-platform" id="activity-platform"></div>
  </div>
</div>

<div class="section">
  <h3>stats</h3>
  <div class="stat-grid">
    <div class="stat-card">
      <div class="stat-value" id="post-count">0</div>
      <div class="stat-label">posts</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="comment-count">0</div>
      <div class="stat-label">comments</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="controversy">0%</div>
      <div class="stat-label">
        approval
        <div style="font-size:.75rem;margin-top:.2rem;color:#555">
          <span id="upvote-count">0</span>‚Üë <span id="downvote-count">0</span>‚Üì
        </div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="join-num">#0</div>
      <div class="stat-label">member</div>
    </div>
  </div>
</div>

<div class="section">
  <h3>last post</h3>
  <div id="last-post" style="color:#777">no posts yet</div>
</div>

<div id="guestbook-section" class="guestbook-section hidden">
  <h3 style="color:var(--accent-color)">guestbook</h3>
  
  <div id="guestbook-form" class="guestbook-form hidden">
    <textarea id="gb-message" maxlength="500" placeholder="leave a message..."></textarea>
    <button onclick="postToGuestbook()">post</button>
    <button onclick="openUploadcare()">upload</button>
  </div>
  
  <div id="guestbook-entries"></div>
</div>

</div>

<uc-config
  ctx-name="my-uploader"
  source-list="local, camera, url"
  max-local-file-size-bytes="15728640"
  pubkey="e1c10946e2093cf2bb48"
></uc-config>

<uc-file-uploader-regular
  ctx-name="my-uploader"
  class="uc-dark"
></uc-file-uploader-regular>

<uc-upload-ctx-provider ctx-name="my-uploader"></uc-upload-ctx-provider>

<script type="module">
import * as UC from 'https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@1/web/uc-file-uploader-regular.min.js'
UC.defineComponents(UC)

if(!localStorage.getItem("nickname")){
  location.href="/"
}

const currentUser = localStorage.getItem("nickname")
const profileNick = window.location.pathname.split('/').pop()
let isFollowing = false
let uploadedFileUrl = null
let uploadedFileType = null
let accentColor = '#4c4'

const uploader = document.querySelector('uc-file-uploader-regular')

uploader.addEventListener('file-upload-success', (e) => {
  const file = e.detail
  uploadedFileUrl = file.cdnUrl
  
  if(file.mimeType.startsWith('video/')){
    uploadedFileType = 'video'
    uploadedFileUrl = `${file.cdnUrl}-/format/mp4/-/quality/lighter/`
  } else if(file.mimeType.startsWith('audio/')){
    uploadedFileType = 'audio'
  } else if(file.mimeType === 'image/gif'){
    uploadedFileType = 'gif'
  } else {
    uploadedFileType = 'image'
  }
  
  alert('file uploaded! now post your message')
})

window.openUploadcare = function(){
  uploader.style.display = 'block'
}

function showFollowers(){
  location.href = `/profile/${profileNick}/followers`
}

function showFollowing(){
  location.href = `/profile/${profileNick}/following`
}

function copyRSS(){
  const rssUrl = `${window.location.origin}/rss/${profileNick}.xml`
  navigator.clipboard.writeText(rssUrl).then(() => {
    alert("rss feed url copied to clipboard!")
  }).catch(() => {
    prompt("copy this rss feed url:", rssUrl)
  })
}

async function loadActivity(){
  try {
    const r = await fetch(`/api/activity/${profileNick}`)
    const data = await r.json()
    
    const statusEl = document.getElementById('activity-status')
    const contentEl = document.getElementById('activity-content')
    const platformEl = document.getElementById('activity-platform')
    
    if(data.status === 'offline' || !data.activity_type){
      statusEl.textContent = 'offline'
      statusEl.classList.remove('online')
      contentEl.textContent = ''
      platformEl.textContent = ''
      return
    }
    
    statusEl.textContent = 'online'
    statusEl.classList.add('online')
    
    let verb = ''
    if(data.activity_type === 'watching') verb = 'watching'
    else if(data.activity_type === 'listening') verb = 'listening to'
    else verb = 'browsing'
    
    if(data.platform){
      contentEl.textContent = data.title || 'untitled'
      platformEl.textContent = `${verb} on ${data.platform}`
    } else {
      contentEl.textContent = data.title || 'browsing'
      platformEl.textContent = verb
    }
  } catch(e) {
    document.getElementById('activity-status').textContent = 'offline'
  }
}

async function loadProfile(){
  const r = await fetch(`/api/profile/${profileNick}`)
  if(r.status === 404){
    document.getElementById('app').innerHTML = '<h2>user not found</h2>'
    return
  }
  
  const data = await r.json()
  
  accentColor = data.guestbook_color || '#4c4'
  document.documentElement.style.setProperty('--accent-color', accentColor)
  
  document.getElementById('username').textContent = '@' + data.nickname
  document.getElementById('follower-count').textContent = data.followers || 0
  document.getElementById('following-count').textContent = data.following || 0
  document.getElementById('pronouns').textContent = data.pronouns || ''
  document.getElementById('timezone').textContent = data.timezone ? `¬∑ ${data.timezone}` : ''
  document.getElementById('bio').textContent = data.bio || ''
  document.getElementById('post-count').textContent = data.posts
  document.getElementById('comment-count').textContent = data.comments
  document.getElementById('controversy').textContent = data.controversyScore + '%'
  document.getElementById('upvote-count').textContent = data.upvotes || 0
  document.getElementById('downvote-count').textContent = data.downvotes || 0
  document.getElementById('join-num').textContent = '#' + data.joinNumber
  
  if(data.lastPost){
    const time = timeago(data.lastPost.created_at)
    document.getElementById('last-post').innerHTML = `
      <div style="color:#eaeaea">${escapeHtml(data.lastPost.content)}</div>
      <div style="font-size:.8rem;margin-top:.3rem">${time}</div>
    `
  }
  
  if(profileNick.toLowerCase() === currentUser.toLowerCase()){
    document.getElementById('edit-btn').classList.remove('hidden')
  } else {
    document.getElementById('follow-btn').classList.remove('hidden')
    checkFollowStatus()
  }
  
  if(data.guestbook_enabled){
    document.getElementById('guestbook-section').classList.remove('hidden')
    if(profileNick.toLowerCase() !== currentUser.toLowerCase()){
      document.getElementById('guestbook-form').classList.remove('hidden')
    }
    loadGuestbook()
  }
  
  loadActivity()
}

async function loadGuestbook() {
  const r = await fetch(`/api/guestbook/${profileNick}`)
  const data = await r.json()
  
  const container = document.getElementById('guestbook-entries')
  container.innerHTML = ''
  
  if(data.entries.length === 0){
    container.innerHTML = '<div style="color:#777;text-align:center;padding:2rem">no entries yet</div>'
    return
  }
  
  data.entries.forEach(entry => {
    const div = document.createElement('div')
    div.className = 'gb-entry'
    
    let mediaHtml = ''
    if (entry.media_url) {
      if (entry.media_type === 'image' || entry.media_type === 'gif') {
        mediaHtml = `<div class="gb-media"><img src="${entry.media_url}" loading="lazy"></div>`
      } else if (entry.media_type === 'video') {
        mediaHtml = `<div class="gb-media"><video src="${entry.media_url}" controls></video></div>`
      } else if (entry.media_type === 'audio') {
        mediaHtml = `<div class="gb-media"><audio src="${entry.media_url}" controls></audio></div>`
      }
    }
    
    const deleteBtn = profileNick.toLowerCase() === currentUser.toLowerCase() ? 
      `<button onclick="deleteEntry(${entry.id})" style="padding:.2rem .5rem;font-size:.8rem">delete</button>` : ''
    
    div.innerHTML = `
      <div class="gb-meta">
        <div>
          <a href="/profile/${entry.author_nick}">@${entry.author_nick}</a>
          <span> ¬∑ ${timeago(entry.created_at)}</span>
        </div>
        ${deleteBtn}
      </div>
      ${entry.message ? `<div style="color:#eaeaea">${escapeHtml(entry.message)}</div>` : ''}
      ${mediaHtml}
    `
    
    container.appendChild(div)
  })
}

window.postToGuestbook = async function() {
  const message = document.getElementById('gb-message').value.trim()
  
  if (!message && !uploadedFileUrl) {
    alert('write a message or upload media!')
    return
  }
  
  const r = await fetch('/api/guestbook', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      user_nick: profileNick,
      author_nick: currentUser,
      message: message || null,
      media_url: uploadedFileUrl,
      media_type: uploadedFileType
    })
  })
  
  if (r.status === 403) {
    const data = await r.json()
    if(data.banned){
      alert("you're banned!")
      location.href = '/banned'
    } else {
      alert("guestbook is disabled")
    }
    return
  }
  
  if (r.status === 429) {
    alert("too many posts, slow down!")
    return
  }
  
  if (!r.ok) {
    alert("error posting. try again.")
    return
  }
  
  document.getElementById('gb-message').value = ''
  uploadedFileUrl = null
  uploadedFileType = null
  uploader.style.display = 'none'
  
  loadGuestbook()
}

window.deleteEntry = async function(id) {
  if (!confirm('delete this guestbook entry?')) return
  
  await fetch(`/api/guestbook/${id}`, {
    method: 'DELETE',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ nickname: currentUser })
  })
  
  loadGuestbook()
}

async function checkFollowStatus(){
  const r = await fetch(`/api/is-following?follower=${currentUser}&following=${profileNick}`)
  const data = await r.json()
  isFollowing = data.isFollowing
  
  const btn = document.getElementById('follow-btn')
  if(isFollowing){
    btn.textContent = 'following'
    btn.classList.add('following')
  } else {
    btn.textContent = 'follow'
    btn.classList.remove('following')
  }
}

async function toggleFollow(){
  const btn = document.getElementById('follow-btn')
  
  if(isFollowing){
    const r = await fetch(`/api/follow/${profileNick}`, {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({follower: currentUser})
    })
    if(r.ok){
      isFollowing = false
      btn.textContent = 'follow'
      btn.classList.remove('following')
      const count = parseInt(document.getElementById('follower-count').textContent)
      document.getElementById('follower-count').textContent = count - 1
    }
  } else {
    const r = await fetch('/api/follow', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({follower: currentUser, following: profileNick})
    })
    if(r.ok){
      isFollowing = true
      btn.textContent = 'following'
      btn.classList.add('following')
      const count = parseInt(document.getElementById('follower-count').textContent)
      document.getElementById('follower-count').textContent = count + 1
    }
  }
}

function escapeHtml(text) {
  const div = document.createElement('div')
  div.textContent = text
  return div.innerHTML
}

function timeago(t){
  const s=Math.floor((Date.now()-t)/1000)
  if(s<60) return s+"s ago"
  const m=Math.floor(s/60)
  if(m<60) return m+"m ago"
  const h=Math.floor(m/60)
  if(h<24) return h+"h ago"
  const d=Math.floor(h/24)
  if(d<7) return d+"d ago"
  return Math.floor(d/7)+"w ago"
}

window.showFollowers = showFollowers
window.showFollowing = showFollowing
window.copyRSS = copyRSS
window.toggleFollow = toggleFollow

loadProfile()
setInterval(loadActivity, 10000)
</script>
</body>
</html>
