<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Dashboard</title>
<style>
body{margin:0;font-family:system-ui,sans-serif;background:#0f0f0f;color:#eaeaea;padding:2rem}
#login{max-width:400px;margin:5rem auto;text-align:center}
#dashboard{max-width:1200px;margin:0 auto;display:none}
h1{font-size:2rem;margin:0 0 2rem 0}
input,textarea{width:100%;background:#0f0f0f;color:#eaeaea;border:1px solid #222;padding:.7rem;margin:.5rem 0;font-size:1rem;box-sizing:border-box}
button{padding:.7rem 1.5rem;border:1px solid #555;border-radius:.25rem;background:none;color:#aaa;cursor:pointer;font-size:1rem;margin:.5rem}
button:hover{border-color:#eaeaea;color:#fff}
.section{background:#111;border:1px solid #222;border-radius:.5rem;padding:1.5rem;margin:2rem 0}
.report,.post,.user{background:#0a0a0a;border:1px solid #222;padding:1rem;margin:1rem 0;border-radius:.25rem}
.post.flagged{border-left:3px solid #f80}
.fact-check-badge{background:#f80;color:#000;padding:.2rem .5rem;border-radius:.25rem;font-size:.75rem;font-weight:bold;margin-left:.5rem}
.fact-check-display{background:#221100;border-left:3px solid #f80;padding:.7rem;margin:.5rem 0;font-size:.9rem;color:#ffaa44}
.report-actions{margin-top:1rem}
select{background:#0f0f0f;color:#eaeaea;border:1px solid #222;padding:.5rem;font-size:1rem}
.error{color:#c44;margin:.5rem 0}
.success{color:#4c4;margin:.5rem 0}
.small{font-size:.85rem;color:#777}
.tabs{display:flex;gap:1rem;margin-bottom:2rem}
.tab{padding:.7rem 1.5rem;border:1px solid #555;border-radius:.25rem;background:none;color:#aaa;cursor:pointer}
.tab.active{border-color:#eaeaea;color:#fff}
.tab-content{display:none}
.tab-content.active{display:block}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-content{background:#111;border:1px solid #333;border-radius:.5rem;padding:2rem;max-width:600px;width:90%}
.modal-content h3{margin-top:0}
.modal-content button{margin:.5rem .25rem}
</style>
</head>
<body>

<div id="login">
<h1>Admin Login</h1>
<input type="password" id="pass" placeholder="Admin password">
<div class="error" id="error"></div>
<button onclick="login()">Login</button>
</div>

<div id="dashboard">
<h1>Admin Dashboard</h1>

<div class="tabs">
<button class="tab active" onclick="showTab('reports')">Reports</button>
<button class="tab" onclick="showTab('posts')">All Posts</button>
<button class="tab" onclick="showTab('users')">All Users</button>
<button class="tab" onclick="showTab('bans')">Banned Users</button>
<button class="tab" onclick="showTab('broadcast')">Broadcast</button>
</div>

<div id="reports-tab" class="tab-content active">
<div class="section">
<h2>Pending Reports</h2>
<div id="reports-list"></div>
</div>
</div>

<div id="posts-tab" class="tab-content">
<div class="section">
<h2>All Posts</h2>
<div id="posts-list"></div>
</div>
</div>

<div id="users-tab" class="tab-content">
<div class="section">
<h2>All Users</h2>
<div id="users-list"></div>
</div>
</div>

<div id="bans-tab" class="tab-content">
<div class="section">
<h2>Banned Users</h2>
<div id="bans-list"></div>
</div>
</div>

<div id="broadcast-tab" class="tab-content">
<div class="section">
<h2>Broadcast Message</h2>
<p class="small">Send a message to all users</p>
<input type="text" id="broadcast-subject" placeholder="Subject (max 100 chars)" maxlength="100">
<textarea id="broadcast-content" placeholder="Message content (max 500 chars)" maxlength="500" style="width:100%;min-height:150px;margin:1rem 0;padding:.7rem;background:#0f0f0f;color:#eaeaea;border:1px solid #222;box-sizing:border-box"></textarea>
<div class="small" style="text-align:right;margin-bottom:1rem"><span id="broadcast-count">0</span>/500</div>
<button onclick="sendBroadcast()">Send to All Users</button>
<div id="broadcast-result" style="margin-top:1rem"></div>
</div>
</div>

</div>

<div id="fact-check-modal" class="modal">
<div class="modal-content">
<h3>Fact Check Post</h3>
<p class="small" id="modal-post-content"></p>
<textarea id="fact-check-message" placeholder="Enter your fact check message (max 500 chars)" maxlength="500" style="width:100%;min-height:120px;margin:1rem 0;padding:.7rem;background:#0f0f0f;color:#eaeaea;border:1px solid #222;box-sizing:border-box"></textarea>
<div class="small" style="text-align:right;margin-bottom:1rem"><span id="fact-check-count">0</span>/500</div>
<button onclick="submitFactCheck()">Add Fact Check</button>
<button onclick="closeFactCheckModal()">Cancel</button>
</div>
</div>

<script>
let currentTab = 'reports'
let currentFactCheckPostId = null
let postsData = []

async function login() {
  const pass = document.getElementById('pass').value
  const r = await fetch('/api/admin/verify', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({password: pass})
  })
  const data = await r.json()
  if (data.valid) {
    document.getElementById('login').style.display = 'none'
    document.getElementById('dashboard').style.display = 'block'
    loadReports()
  } else {
    document.getElementById('error').textContent = 'Invalid password'
  }
}

function showTab(tab) {
  currentTab = tab
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
  event.target.classList.add('active')
  document.getElementById(tab + '-tab').classList.add('active')
  
  if (tab === 'reports') loadReports()
  if (tab === 'posts') loadPosts()
  if (tab === 'users') loadUsers()
  if (tab === 'bans') loadBans()
}

async function loadReports() {
  const r = await fetch('/api/admin/reports')
  const data = await r.json()
  const list = document.getElementById('reports-list')
  
  if (data.reports.length === 0) {
    list.innerHTML = '<p class="small">No reports found</p>'
    return
  }
  
  list.innerHTML = data.reports.map(rep => `
    <div class="report">
      <div><strong>Type:</strong> ${rep.type}</div>
      <div><strong>Reporter:</strong> ${rep.reporter}</div>
      ${rep.target_user ? `<div><strong>Reported User:</strong> ${rep.target_user}</div>` : ''}
      ${rep.target_post ? `<div><strong>Post ID:</strong> ${rep.target_post}</div>` : ''}
      <div><strong>Reason:</strong> ${rep.reason}</div>
      <div class="small">Reported: ${new Date(rep.created_at).toLocaleString()}</div>
      <div class="report-actions">
        <button onclick="banUser('${rep.target_user || rep.reporter}', ${rep.id})">Ban User</button>
        ${rep.target_post ? `<button onclick="deletePost(${rep.target_post}, ${rep.id})">Delete Post</button>` : ''}
        ${rep.target_post ? `<button onclick="openFactCheckModal(${rep.target_post}, '${rep.reason}')" style="color:#f80">Fact Check</button>` : ''}
        <button onclick="resolveReport(${rep.id})">Mark Resolved</button>
      </div>
    </div>
  `).join('')
}

async function loadPosts() {
  const r = await fetch('/api/admin/posts')
  const data = await r.json()
  postsData = data.posts
  
  // Get fact checks for all posts
  const factChecks = {}
  for (const post of data.posts.slice(0, 50)) {
    const fcr = await fetch(`/api/fact-check/${post.id}`)
    const fcdata = await fcr.json()
    if (fcdata.factCheck) {
      factChecks[post.id] = fcdata.factCheck
    }
  }
  
  const list = document.getElementById('posts-list')
  
  list.innerHTML = data.posts.slice(0, 50).map(post => {
    const fc = factChecks[post.id]
    return `
      <div class="post ${fc ? 'flagged' : ''}">
        <div>
          <strong>ID:</strong> ${post.id} | <strong>User:</strong> ${post.nickname}
          ${fc ? '<span class="fact-check-badge">FACT CHECKED</span>' : ''}
        </div>
        <div style="margin:.5rem 0">${post.content}</div>
        ${fc ? `<div class="fact-check-display">⚠️ Fact Check: ${fc.admin_message}</div>` : ''}
        <div class="small">${new Date(post.created_at).toLocaleString()}</div>
        <button onclick="openFactCheckModal(${post.id}, '${post.content.replace(/'/g, "\\'")}')">
          ${fc ? 'Edit' : 'Add'} Fact Check
        </button>
        ${fc ? `<button onclick="removeFactCheck(${post.id})" style="color:#c44">Remove Fact Check</button>` : ''}
        <button onclick="deletePost(${post.id})">Delete Post</button>
      </div>
    `
  }).join('')
}

async function loadUsers() {
  const r = await fetch('/api/admin/users')
  const data = await r.json()
  const list = document.getElementById('users-list')
  
  list.innerHTML = data.users.map(user => `
    <div class="user">
      <div><strong>${user.nickname}</strong></div>
      <div class="small">Joined: ${new Date(user.created_at).toLocaleString()}</div>
      <button onclick="banUser('${user.nickname}')">Ban</button>
      <button onclick="deleteAccount('${user.nickname}')" style="color:#c44">Delete Account</button>
    </div>
  `).join('')
}

async function loadBans() {
  const r = await fetch('/api/admin/bans')
  const data = await r.json()
  const list = document.getElementById('bans-list')
  
  if (data.bans.length === 0) {
    list.innerHTML = '<p class="small">No banned users</p>'
    return
  }
  
  list.innerHTML = data.bans.map(ban => {
    const timeLeft = ban.banned_until === -1 ? 'Permanent' : 
      new Date(ban.banned_until) < Date.now() ? 'Expired' :
      Math.ceil((ban.banned_until - Date.now()) / 1000 / 60 / 60 / 24) + ' days left'
    
    return `
      <div class="user">
        <div><strong>${ban.nickname}</strong></div>
        <div><strong>Reason:</strong> ${ban.reason}</div>
        <div class="small">Banned: ${new Date(ban.banned_at).toLocaleString()}</div>
        <div class="small">Duration: ${timeLeft}</div>
        <button onclick="unbanUser('${ban.nickname}')" style="color:#4c4">Unban / Appeal</button>
      </div>
    `
  }).join('')
}

function openFactCheckModal(postId, content) {
  currentFactCheckPostId = postId
  document.getElementById('modal-post-content').textContent = `Post: "${content}"`
  
  // Load existing fact check if any
  fetch(`/api/fact-check/${postId}`)
    .then(r => r.json())
    .then(data => {
      if (data.factCheck) {
        document.getElementById('fact-check-message').value = data.factCheck.admin_message
        document.getElementById('fact-check-count').textContent = data.factCheck.admin_message.length
      } else {
        document.getElementById('fact-check-message').value = ''
        document.getElementById('fact-check-count').textContent = '0'
      }
    })
  
  document.getElementById('fact-check-modal').classList.add('show')
}

function closeFactCheckModal() {
  document.getElementById('fact-check-modal').classList.remove('show')
  currentFactCheckPostId = null
  document.getElementById('fact-check-message').value = ''
}

async function submitFactCheck() {
  const message = document.getElementById('fact-check-message').value.trim()
  if (!message) {
    alert('Please enter a fact check message')
    return
  }
  
  const r = await fetch('/api/admin/fact-check', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      post_id: currentFactCheckPostId,
      admin_message: message
    })
  })
  
  if (r.ok) {
    alert('Fact check added!')
    closeFactCheckModal()
    if (currentTab === 'posts') loadPosts()
  } else {
    alert('Error adding fact check')
  }
}

async function removeFactCheck(postId) {
  if (!confirm('Remove fact check from this post?')) return
  
  const r = await fetch(`/api/admin/fact-check/${postId}`, {method: 'DELETE'})
  
  if (r.ok) {
    alert('Fact check removed!')
    if (currentTab === 'posts') loadPosts()
  } else {
    alert('Error removing fact check')
  }
}

async function banUser(nickname, reportId) {
  const duration = prompt('Ban duration:\n1 - 1 day\n7 - 7 days\n30 - 30 days\n365 - 1 year\ninfinite - Permanent')
  if (!duration) return
  
  const reason = prompt('Ban reason:')
  if (!reason) return
  
  if (!confirm(`Ban ${nickname} for ${duration === 'infinite' ? 'forever' : duration + ' days'}?`)) return
  
  await fetch('/api/admin/ban', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({nickname, reason, duration})
  })
  
  alert('User banned!')
  if (reportId) await resolveReport(reportId)
  loadReports()
}

async function deletePost(postId, reportId) {
  if (!confirm('Delete this post?')) return
  
  await fetch(`/api/admin/post/${postId}`, {method: 'DELETE'})
  alert('Post deleted!')
  
  if (reportId) await resolveReport(reportId)
  if (currentTab === 'reports') loadReports()
  if (currentTab === 'posts') loadPosts()
}

async function resolveReport(id) {
  await fetch('/api/admin/resolve-report', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id})
  })
  loadReports()
}

async function deleteAccount(nickname) {
  if (!confirm(`Delete ${nickname}'s account permanently? This cannot be undone.`)) return
  
  await fetch(`/api/admin/account/${nickname}`, {method: 'DELETE'})
  alert('Account deleted! User will be sent to hell.')
  
  if (currentTab === 'users') loadUsers()
}

async function unbanUser(nickname) {
  if (!confirm(`Unban ${nickname}? They'll be able to access the site again.`)) return
  
  await fetch('/api/admin/unban', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({nickname})
  })
  
  alert('User unbanned!')
  loadBans()
}

document.getElementById('broadcast-content')?.addEventListener('input', (e) => {
  document.getElementById('broadcast-count').textContent = e.target.value.length
})

document.getElementById('fact-check-message')?.addEventListener('input', (e) => {
  document.getElementById('fact-check-count').textContent = e.target.value.length
})

async function sendBroadcast() {
  const subject = document.getElementById('broadcast-subject').value.trim()
  const content = document.getElementById('broadcast-content').value.trim()
  const result = document.getElementById('broadcast-result')
  
  if (!subject || !content) {
    result.innerHTML = '<p style="color:#c44">Please fill in both subject and message</p>'
    return
  }
  
  if (!confirm(`Send this message to ALL users?`)) return
  
  result.innerHTML = '<p style="color:#aaa">Sending...</p>'
  
  const r = await fetch('/api/admin/broadcast', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({subject, content})
  })
  
  if (r.ok) {
    result.innerHTML = '<p style="color:#4c4">Broadcast sent to all users!</p>'
    document.getElementById('broadcast-subject').value = ''
    document.getElementById('broadcast-content').value = ''
    document.getElementById('broadcast-count').textContent = '0'
  } else {
    result.innerHTML = '<p style="color:#c44">Error sending broadcast</p>'
  }
}
</script>
</body>
</html>
