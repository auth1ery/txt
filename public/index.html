<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>txt</title>
<style>
body{margin:0;font-family:system-ui,sans-serif;background:#0f0f0f;color:#eaeaea}
#app{max-width:600px;margin:auto;padding:1rem}
textarea,input{width:100%;background:#0f0f0f;color:#eaeaea;border:1px solid #222;padding:.5rem;margin:.3rem 0;box-sizing:border-box}
button{padding:.4rem .8rem;margin:.2rem;border:1px solid #555;border-radius:.25rem;background:none;color:#aaa;cursor:pointer}
button:hover{border-color:#eaeaea;color:#fff}
.post{border-bottom:1px solid #222;padding:.5rem 0;position:relative}
.meta{font-size:.8rem;color:#777;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
.comment{font-size:.85rem;margin-left:1rem;color:#777;display:flex;justify-content:space-between;align-items:center}
.comment button{padding:.2rem .4rem;font-size:.7rem}
.reply-box{margin-left:1rem;display:flex;gap:.3rem;margin-top:.2rem}
.hidden{display:none}
a{color:#777;text-decoration:none}
a:hover{color:#fff}
#more,#refresh{display:block;margin:.5rem 0}
.menu{position:relative;display:inline-block}
.dots{background:none;border:none;color:#777;font-size:1.2rem;cursor:pointer;padding:0 .5rem}
.dots:hover{color:#fff}
.dropdown{display:none;position:absolute;background:#111;border:1px solid #333;border-radius:.25rem;padding:.5rem;min-width:180px;right:0;z-index:10}
.dropdown.show{display:block}
.dropdown button{display:block;width:100%;text-align:left;margin:.2rem 0;padding:.4rem}
.footer{text-align:center;padding:2rem 0;margin-top:2rem;border-top:1px solid #222;font-size:.85rem}
.footer a{color:#777;text-decoration:none;margin:0 1rem}
.footer a:hover{color:#eaeaea}
</style>
</head>
<body>
<div id="app">
<h2 id="greeting"></h2>
<textarea id="postinput" maxlength="200" placeholder="write"></textarea>
<button onclick="createpost()">post</button>
<button onclick="deleteaccount()" style="float:right;color:#c44">delete account</button>
<div id="posts"></div>
<button id="more" onclick="load()">more posts</button>
<button id="refresh" onclick="location.reload()">refresh</button>
</div>

<div class="footer">
  <a href="/privacy">privacy policy</a>
  <a href="/terms">terms of service</a>
  <a href="https://txt1.statuspage.io/" target="_blank">status</a>
</div>

<script>
if(!localStorage.getItem("nickname")){
  location.href="/"
}

let nickname=localStorage.getItem("nickname"),offset=0

function getGreeting() {
  const hour = new Date().getHours()
  const lastGreeting = localStorage.getItem('lastGreeting')
  const lastGreetingTime = localStorage.getItem('lastGreetingTime')
  const now = Date.now()
  
  const timeGreetings = {
    morning: `good morning, ${nickname}`,
    evening: `good evening, ${nickname}`,
    night: `not sleeping ${nickname}?`
  }
  
  const randomGreetings = [
    `welcome, ${nickname}`,
    `hi ${nickname}`,
    `scrolling now, ${nickname}?`,
    `i like your shirt ${nickname}`,
    `yo ${nickname}`,
    `what time is it, ${nickname}?`,
    `hey there ${nickname}`
  ]
  
  let greeting
  
  if (hour >= 5 && hour < 12) {
    greeting = timeGreetings.morning
  } else if (hour >= 17 && hour < 22) {
    greeting = timeGreetings.evening
  } else if (hour >= 22 || hour < 5) {
    greeting = timeGreetings.night
  } else {
    greeting = randomGreetings[Math.floor(Math.random() * randomGreetings.length)]
  }
  
  if (lastGreeting === greeting && now - lastGreetingTime < 3600000) {
    greeting = randomGreetings[Math.floor(Math.random() * randomGreetings.length)]
  }
  
  localStorage.setItem('lastGreeting', greeting)
  localStorage.setItem('lastGreetingTime', now)
  
  return greeting
}

document.getElementById('greeting').textContent = getGreeting()

async function checkBan(){
  const r = await fetch('/api/check-ban', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({nickname})
  })
  const data = await r.json()
  if(data.banned){
    location.href = '/banned'
  }
}

async function checkAccountExists(){
  const r = await fetch('/api/profile/' + nickname)
  if(r.status === 404){
    location.href = '/hell'
  }
}

checkBan()
checkAccountExists()

function timeago(t){
  const s=Math.floor((Date.now()-t)/1000)
  if(s<60) return s+"s ago"
  const m=Math.floor(s/60)
  if(m<60) return m+"m ago"
  const h=Math.floor(m/60)
  if(h<24) return h+"h ago"
  const d=Math.floor(h/24)
  if(d<7) return d+"d ago"
  return Math.floor(d/7)+"w ago"
}

function toggleMenu(id){
  const menu = document.getElementById("menu"+id)
  document.querySelectorAll('.dropdown').forEach(d => {
    if(d.id !== "menu"+id) d.classList.remove("show")
  })
  menu.classList.toggle("show")
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.menu')) {
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove("show"))
  }
})

async function reportPost(postId, postUser){
  const reason = prompt("What's the reason for reporting this post?")
  if(!reason) return
  
  await fetch('/api/report', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      reporter: nickname,
      type: 'post',
      target_user: postUser,
      target_post: postId,
      reason
    })
  })
  
  alert("Great! Human moderators will review it shortly.")
  toggleMenu(postId)
}

async function reportUser(postId, postUser){
  const reason = prompt("What's the reason for reporting this user?")
  if(!reason) return
  
  await fetch('/api/report', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      reporter: nickname,
      type: 'user',
      target_user: postUser,
      reason
    })
  })
  
  alert("Great! Human moderators will review it shortly.")
  toggleMenu(postId)
}

async function reportBoth(postId, postUser){
  const reason = prompt("What's the reason for reporting this user and post?")
  if(!reason) return
  
  await fetch('/api/report', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      reporter: nickname,
      type: 'both',
      target_user: postUser,
      target_post: postId,
      reason
    })
  })
  
  alert("Great! Human moderators will review it shortly.")
  toggleMenu(postId)
}

function createcommentdiv(c){
  const div=document.createElement("div")
  div.className="comment"
  div.innerHTML=`<span>@${c.nickname}: ${c.content} · ${timeago(c.created_at)}</span>
                 <button onclick="showreply(${c.id},${c.post_id})">reply</button>
                 <div class="reply-box hidden" id="reply${c.id}">
                   <input maxlength="100" placeholder="reply">
                   <button onclick="sendreply(${c.post_id},${c.id})">send</button>
                 </div>`
  return div
}

async function load(){
  const r=await fetch("/api/posts?offset="+offset)
  const d=await r.json()
  const el=document.getElementById("posts")
  d.posts.forEach(p=>{
    const div=document.createElement("div")
    div.className="post"
    div.dataset.postId=p.id
    div.innerHTML=`<div>${p.content}</div>
      <div class="meta">
        <a href="/profile/${p.nickname}">@${p.nickname}</a>
        <span>${timeago(p.created_at)}</span>
        <span>score: <span id="score${p.id}">${p.score}</span></span>
        <button onclick="react(${p.id},1)">+</button>
        <button onclick="react(${p.id},-1)">-</button>
        <button onclick="togglecomments(${p.id})">comments</button>
        <div class="menu">
          <button class="dots" onclick="toggleMenu(${p.id})">⋯</button>
          <div id="menu${p.id}" class="dropdown">
            <button onclick="reportPost(${p.id}, '${p.nickname}')">Report Post</button>
            <button onclick="reportUser(${p.id}, '${p.nickname}')">Report User</button>
            <button onclick="reportBoth(${p.id}, '${p.nickname}')">Report Both</button>
          </div>
        </div>
      </div>
      <div id="comments${p.id}" class="hidden"></div>
      <div class="reply-box hidden" id="newcomment${p.id}">
        <input maxlength="100" placeholder="comment">
        <button onclick="sendcomment(${p.id})">send</button>
      </div>`
    const commentsdiv=div.querySelector("#comments"+p.id)
    d.comments.filter(c=>c.post_id===p.id&&!c.parent_id).forEach(c=>{
      commentsdiv.appendChild(createcommentdiv(c))
    })
    el.appendChild(div)
  })
  offset+=20
}

function togglecomments(id){
  document.getElementById("comments"+id).classList.toggle("hidden")
  document.getElementById("newcomment"+id).classList.toggle("hidden")
}

async function createpost(){
  const i=document.getElementById("postinput")
  if(!i.value.trim()) return
  const r=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,content:i.value})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  if(r.status === 429){
    const data = await r.json()
    alert(data.error || "Too many posts, slow down!")
    return
  }
  if(!r.ok){
    alert("Error posting. Try again.")
    return
  }
  const data=await r.json()
  i.value=""
  document.getElementById("posts").innerHTML=""
  offset=0
  load()
}

async function react(id,v){
  const r=await fetch("/api/react",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id:id,value:v})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  const data=await r.json()
  document.getElementById("score"+id).textContent=data.score
}

async function sendcomment(post_id){
  const input=document.querySelector(`#newcomment${post_id} input`)
  if(!input.value.trim()) return
  const r=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id,content:input.value})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  if(r.status === 429){
    const data = await r.json()
    alert(data.error || "Too many comments, slow down!")
    return
  }
  if(!r.ok){
    alert("Error commenting. Try again.")
    return
  }
  input.value=""
  const data=await r.json()
  const div=createcommentdiv({nickname,content:input.value,created_at:Date.now(),id:data.id,post_id})
  document.getElementById("comments"+post_id).appendChild(div)
  document.getElementById("comments"+post_id).classList.remove("hidden")
}

function showreply(comment_id,post_id){
  document.getElementById("reply"+comment_id).classList.toggle("hidden")
}

async function sendreply(post_id,parent_id){
  const input=document.querySelector(`#reply${parent_id} input`)
  if(!input.value.trim()) return
  const r=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id,content:input.value,parent_id})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  if(r.status === 429){
    const data = await r.json()
    alert(data.error || "Too many comments, slow down!")
    return
  }
  if(!r.ok){
    alert("Error replying. Try again.")
    return
  }
  const data=await r.json()
  const div=createcommentdiv({nickname,content:input.value,created_at:Date.now(),id:data.id,post_id})
  document.querySelector(`#comments${post_id}`).appendChild(div)
  input.value=""
  document.querySelector(`#comments${post_id}`).classList.remove("hidden")
}

async function deleteaccount(){
  if(!confirm("delete your account? this will remove all your posts, comments, and reactions. this cannot be undone.")) return
  const r=await fetch("/api/account/"+nickname,{method:"DELETE"})
  if(r.status===200){
    localStorage.removeItem("nickname")
    alert("account deleted")
    location.href="/"
  }else{
    alert("error deleting account")
  }
}

load()
</script>
</body>
</html>
