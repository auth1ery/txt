<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>txt</title>
<style>
body{margin:0;font-family:system-ui,sans-serif;background:#0f0f0f;color:#eaeaea}
#app{max-width:600px;margin:auto;padding:1rem}
textarea,input{width:100%;background:#0f0f0f;color:#eaeaea;border:1px solid #222;padding:.5rem;margin:.3rem 0}
button{padding:.4rem .8rem;margin:.2rem;border:1px solid #555;border-radius:.25rem;background:none;color:#aaa;cursor:pointer}
button:hover{border-color:#eaeaea;color:#fff}
.post{border-bottom:1px solid #222;padding:.5rem 0}
.meta{font-size:.8rem;color:#777;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
.comment{font-size:.85rem;margin-left:1rem;color:#777;display:flex;justify-content:space-between;align-items:center}
.comment button{padding:.2rem .4rem;font-size:.7rem}
.reply-box{margin-left:1rem;display:flex;gap:.3rem;margin-top:.2rem}
.hidden{display:none}
a{color:#777;text-decoration:none}
a:hover{color:#fff}
#more,#refresh{display:block;margin:.5rem 0}
#counter{
  position: fixed;
  bottom:5px;
  left:50%;
  transform:translateX(-50%);
  font-size:0.7rem;
  color:rgba(255,255,255,0.3);
  text-transform: lowercase;
  z-index:999;
}
</style>
</head>
<body>
<div id="app">
<h2>txt</h2>
<textarea id="postInput" maxlength="200" placeholder="write"></textarea>
<button onclick="createPost()">post</button>
<div id="posts"></div>
<button id="more" onclick="load()">more posts</button>
<button id="refresh" onclick="location.reload()">refresh</button>
</div>
<div id="counter"></div>

<script>
let nickname=localStorage.getItem("nickname"),offset=0

function timeAgo(t){
  const s=Math.floor((Date.now()-t)/1000)
  if(s<60) return s+"s ago"
  const m=Math.floor(s/60)
  if(m<60) return m+"m ago"
  const h=Math.floor(m/60)
  if(h<24) return h+"h ago"
  const d=Math.floor(h/24)
  if(d<7) return d+"d ago"
  return Math.floor(d/7)+"w ago"
}

async function pickName(){
  while(!nickname){
    const n=prompt("nickname (15 max)")
    if(!n) continue
    const r=await fetch("/api/nickname",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname:n})})
    if(r.status===200){nickname=n.toLowerCase();localStorage.setItem("nickname",nickname)}
  }
}

function createCommentDiv(c){
  const div = document.createElement("div")
  div.className = "comment"
  div.innerHTML = `<span>@${c.nickname}: ${c.content} Â· ${timeAgo(c.created_at)}</span>
                   <button onclick="showReply(${c.id},${c.post_id})">reply</button>
                   <div class="reply-box hidden" id="reply${c.id}">
                     <input maxlength="100" placeholder="reply">
                     <button onclick="sendReply(${c.post_id},${c.id})">send</button>
                   </div>`
  return div
}

async function load(){
  const r=await fetch("/api/posts?offset="+offset)
  const d=await r.json()
  const el=document.getElementById("posts")
  d.posts.forEach(p=>{
    const div=document.createElement("div")
    div.className="post"
    div.dataset.postId=p.id
    div.innerHTML=`<div>${p.content}</div>
      <div class="meta">
        <a href="/profile/${p.nickname}">@${p.nickname}</a>
        <span>${timeAgo(p.created_at)}</span>
        <span>score: <span id="score${p.id}">${p.score}</span></span>
        <button onclick="react(${p.id},1)">+</button>
        <button onclick="react(${p.id},-1)">-</button>
        <button onclick="toggleComments(${p.id})">comments</button>
      </div>
      <div id="comments${p.id}" class="hidden"></div>
      <div class="reply-box hidden" id="newcomment${p.id}">
        <input maxlength="100" placeholder="comment">
        <button onclick="sendComment(${p.id})">send</button>
      </div>`
    // append comments
    const commentsDiv = div.querySelector("#comments"+p.id)
    d.comments.filter(c=>c.post_id===p.id && !c.parent_id).forEach(c=>{
      commentsDiv.appendChild(createCommentDiv(c))
    })
    el.appendChild(div)
  })
  offset+=20
}

function toggleComments(id){
  document.getElementById("comments"+id).classList.toggle("hidden")
  document.getElementById("newcomment"+id).classList.toggle("hidden")
}

async function createPost(){
  const i=document.getElementById("postInput")
  if(!i.value.trim()) return
  const r=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,content:i.value})})
  const data=await r.json()
  i.value=""
  document.getElementById("posts").innerHTML=""
  offset=0
  load()
}

async function react(id,v){
  const r=await fetch("/api/react",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id:id,value:v})})
  const data=await r.json()
  document.getElementById("score"+id).textContent=data.score
}

async function sendComment(post_id){
  const input = document.querySelector(`#newcomment${post_id} input`)
  if(!input.value.trim()) return
  const r=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id,content:input.value})})
  input.value=""
  const data=await r.json()
  const div = createCommentDiv({nickname,content:input.value,created_at:Date.now(),id:data.id,post_id})
  document.getElementById("comments"+post_id).appendChild(div)
  document.getElementById("comments"+post_id).classList.remove("hidden")
}

function showReply(comment_id,post_id){
  document.getElementById("reply"+comment_id).classList.toggle("hidden")
}

async function sendReply(post_id,parent_id){
  const input = document.querySelector(`#reply${parent_id} input`)
  if(!input.value.trim()) return
  const r=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id,content:input.value,parent_id})})
  const data=await r.json()
  const div = createCommentDiv({nickname,content:input.value,created_at:Date.now(),id:data.id,post_id})
  document.querySelector(`#comments${post_id}`).appendChild(div)
  input.value=""
  document.querySelector(`#comments${post_id}`).classList.remove("hidden")
}

pickName().then(load)
</script>
</body>
</html>
