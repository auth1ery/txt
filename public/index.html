<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>txt</title>
<style>
body{margin:0;font-family:system-ui,sans-serif;background:#0f0f0f;color:#eaeaea}
#app{max-width:600px;margin:auto;padding:1rem}
#inbox-btn{position:relative}
#inbox-btn .badge{position:absolute;top:-5px;right:-5px;background:#c44;color:#fff;border-radius:50%;padding:2px 6px;font-size:.7rem;font-weight:bold}
#notif-btn{position:relative}
#notif-btn .badge{position:absolute;top:-5px;right:-5px;background:#c44;color:#fff;border-radius:50%;padding:2px 6px;font-size:.7rem;font-weight:bold}
.feed-toggle{display:flex;gap:.5rem;margin:1rem 0}
.feed-toggle button{flex:1}
.feed-toggle button.active{border-color:#eaeaea;color:#fff}
textarea,input{width:100%;background:#0f0f0f;color:#eaeaea;border:1px solid #222;padding:.5rem;margin:.3rem 0;box-sizing:border-box}
button{padding:.4rem .8rem;margin:.2rem;border:1px solid #555;border-radius:.25rem;background:none;color:#aaa;cursor:pointer}
button:hover{border-color:#eaeaea;color:#fff}
.post{border-bottom:1px solid #222;padding:.5rem 0;position:relative}
.repost-header{color:#777;font-size:.85rem;margin-bottom:.3rem}
.repost-header a{color:#888}
.fact-check-warning{background:#221100;border-left:3px solid #f80;padding:.7rem;margin:.5rem 0;font-size:.85rem;color:#ffaa44;border-radius:.25rem}
.fact-check-warning strong{color:#ff8800}
.meta{font-size:.8rem;color:#777;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
.comment{font-size:.85rem;margin-left:1rem;color:#777;display:flex;justify-content:space-between;align-items:center}
.comment button{padding:.2rem .4rem;font-size:.7rem}
.reply-box{margin-left:1rem;display:flex;gap:.3rem;margin-top:.2rem}
.hidden{display:none}
a{color:#777;text-decoration:none}
a:hover{color:#fff}
.mention{color:#4c4;font-weight:bold}
.external-link{color:#88f}
#more,#refresh{display:block;margin:.5rem 0}
.menu{position:relative;display:inline-block}
.dots{background:none;border:none;color:#777;font-size:1.2rem;cursor:pointer;padding:0 .5rem}
.dots:hover{color:#fff}
.dropdown{display:none;position:absolute;background:#111;border:1px solid #333;border-radius:.25rem;padding:.5rem;min-width:180px;right:0;z-index:10}
.dropdown.show{display:block}
.dropdown button{display:block;width:100%;text-align:left;margin:.2rem 0;padding:.4rem}
.footer{text-align:center;padding:2rem 0;margin-top:2rem;border-top:1px solid #222;font-size:.85rem}
.footer a{color:#777;text-decoration:none;margin:0 1rem}
.footer a:hover{color:#eaeaea}
.greeting-link{color:#eaeaea;text-decoration:underline;text-decoration-style:dotted;text-decoration-color:#444;text-decoration-thickness:1px;text-underline-offset:4px;cursor:pointer}
.greeting-link:hover{text-decoration:none;color:#888}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:100;justify-content:center;align-items:center}
.modal.show{display:flex}
.modal-content{background:#0f0f0f;border:1px solid #333;border-radius:.5rem;padding:1.5rem;max-width:400px;width:90%}
.modal-content h3{margin-top:0}
.modal-content button{margin-top:.5rem}
</style>
</head>
<body>
<div id="app">
<h2 id="greeting"></h2>
<button onclick="location.href='/inbox'" id="inbox-btn">inbox</button>
<button onclick="location.href='/notifications'" id="notif-btn">notifications</button>
<button onclick="location.href='/discover'">discover</button>
<div class="feed-toggle">
  <button id="all-btn" class="active" onclick="switchFeed('all')">all</button>
  <button id="following-btn" onclick="switchFeed('following')">following</button>
</div>
<textarea id="postinput" maxlength="200" placeholder="write"></textarea>
<button onclick="createpost()">post</button>
<button onclick="deleteaccount()" style="float:right;color:#c44">delete account</button>
<div id="posts"></div>
<button id="more" onclick="load()">more posts</button>
<button id="refresh" onclick="location.reload()">refresh</button>
</div>

<div id="repost-modal" class="modal">
  <div class="modal-content">
    <h3>repost</h3>
    <p id="repost-content"></p>
    <textarea id="repost-comment" maxlength="200" placeholder="add a comment (optional)"></textarea>
    <button onclick="confirmRepost()">repost</button>
    <button onclick="closeRepostModal()">cancel</button>
  </div>
</div>

<div class="footer">
  <a href="/privacy">privacy policy</a>
  <a href="/terms">terms of service</a>
  <a href="/developers">API</a>
  <a href="https://txt1.statuspage.io/" target="_blank">status</a>
  <a href="/rss.xml" style="color:#f80">ðŸ“¡ RSS feed</a>
</div>

<script>
if(!localStorage.getItem("nickname")){
  location.href="/"
}

let nickname=localStorage.getItem("nickname"),offset=0,currentFeed='all',currentRepostId=null

function getGreeting() {
  const hour = new Date().getHours()
  const lastGreeting = localStorage.getItem('lastGreeting')
  const lastGreetingTime = localStorage.getItem('lastGreetingTime')
  const now = Date.now()
  
  const timeGreetings = {
    morning: `good morning, ${nickname}`,
    evening: `good evening, ${nickname}`,
    night: `not sleeping ${nickname}?`
  }
  
  const randomGreetings = [
    `welcome, ${nickname}`,
    `hi ${nickname}`,
    `scrolling now, ${nickname}?`,
    `hello ${nickname}`
  ]
  
  let greeting
  
  if (hour >= 5 && hour < 12) {
    greeting = timeGreetings.morning
  } else if (hour >= 17 && hour < 22) {
    greeting = timeGreetings.evening
  } else if (hour >= 22 || hour < 5) {
    greeting = timeGreetings.night
  } else {
    greeting = randomGreetings[Math.floor(Math.random() * randomGreetings.length)]
  }
  
  if (lastGreeting === greeting && now - lastGreetingTime < 3600000) {
    greeting = randomGreetings[Math.floor(Math.random() * randomGreetings.length)]
  }
  
  localStorage.setItem('lastGreeting', greeting)
  localStorage.setItem('lastGreetingTime', now)
  
  return greeting
}

const greetingText = getGreeting()
const greetingHTML = greetingText.replace(nickname, `<a href="/profile/${nickname}" class="greeting-link">${nickname}</a>`)
document.getElementById('greeting').innerHTML = greetingHTML

async function checkBan(){
  const r = await fetch('/api/check-ban', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({nickname})
  })
  const data = await r.json()
  if(data.banned){
    location.href = '/banned'
  }
}

async function checkAccountExists(){
  const r = await fetch('/api/profile/' + nickname)
  if(r.status === 404){
    location.href = '/hell'
  }
}

checkBan()
checkAccountExists()

async function checkUnread(){
  const r = await fetch(`/api/messages/unread/${nickname}`)
  const data = await r.json()
  if(data.count > 0){
    const btn = document.getElementById('inbox-btn')
    btn.innerHTML = `inbox <span class="badge">${data.count}</span>`
  }
}

async function checkUnreadNotifications(){
  const r = await fetch(`/api/notifications/unread/${nickname}`)
  const data = await r.json()
  if(data.count > 0){
    const btn = document.getElementById('notif-btn')
    btn.innerHTML = `notifications <span class="badge">${data.count}</span>`
  }
}

checkUnread()
checkUnreadNotifications()
setInterval(checkUnread, 30000)
setInterval(checkUnreadNotifications, 30000)

function switchFeed(type) {
  currentFeed = type
  document.getElementById('all-btn').classList.toggle('active', type === 'all')
  document.getElementById('following-btn').classList.toggle('active', type === 'following')
  document.getElementById('posts').innerHTML = ''
  offset = 0
  load()
}

function escapeHtml(text) {
  const div = document.createElement('div')
  div.textContent = text
  return div.innerHTML
}

function processContent(text) {
  text = escapeHtml(text)
  
  text = text.replace(/@(\w+)/g, '<a href="/profile/$1" class="mention">@$1</a>')
  
  const urlRegex = /(https?:\/\/[^\s]+)/g
  text = text.replace(urlRegex, (url) => {
    const escaped = url.replace(/'/g, '&#39;')
    return `<a href="#" onclick="confirmLink('${escaped}'); return false" class="external-link">${url}</a>`
  })
  
  return text
}

function confirmLink(url) {
  if (confirm("You're going to go OUTSIDE of txt. Make sure you trust the link before you proceed!\n\nGo to: " + url)) {
    window.open(url, '_blank')
  }
}

function timeago(t){
  const s=Math.floor((Date.now()-t)/1000)
  if(s<60) return s+"s ago"
  const m=Math.floor(s/60)
  if(m<60) return m+"m ago"
  const h=Math.floor(m/60)
  if(h<24) return h+"h ago"
  const d=Math.floor(h/24)
  if(d<7) return d+"d ago"
  return Math.floor(d/7)+"w ago"
}

function toggleMenu(id){
  const menu = document.getElementById("menu"+id)
  document.querySelectorAll('.dropdown').forEach(d => {
    if(d.id !== "menu"+id) d.classList.remove("show")
  })
  menu.classList.toggle("show")
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.menu')) {
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove("show"))
  }
})

async function reportPost(postId, postUser){
  const reason = prompt("What's the reason for reporting this post?")
  if(!reason) return
  
  await fetch('/api/report', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      reporter: nickname,
      type: 'post',
      target_user: postUser,
      target_post: postId,
      reason
    })
  })
  
  alert("Great! Human moderators will review it shortly.")
  toggleMenu(postId)
}

async function reportUser(postId, postUser){
  const reason = prompt("What's the reason for reporting this user?")
  if(!reason) return
  
  await fetch('/api/report', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      reporter: nickname,
      type: 'user',
      target_user: postUser,
      reason
    })
  })
  
  alert("Great! Human moderators will review it shortly.")
  toggleMenu(postId)
}

async function reportBoth(postId, postUser){
  const reason = prompt("What's the reason for reporting this user and post?")
  if(!reason) return
  
  await fetch('/api/report', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      reporter: nickname,
      type: 'both',
      target_user: postUser,
      target_post: postId,
      reason
    })
  })
  
  alert("Great! Human moderators will review it shortly.")
  toggleMenu(postId)
}

function sharePost(postId){
  const url = `${window.location.origin}/post/${postId}`
  navigator.clipboard.writeText(url).then(() => {
    alert("Post link copied to clipboard!")
  }).catch(() => {
    prompt("Copy this link:", url)
  })
  toggleMenu(postId)
}

function openRepostModal(postId, content){
  currentRepostId = postId
  document.getElementById('repost-content').textContent = content
  document.getElementById('repost-comment').value = ''
  document.getElementById('repost-modal').classList.add('show')
}

function closeRepostModal(){
  document.getElementById('repost-modal').classList.remove('show')
  currentRepostId = null
}

async function confirmRepost(){
  if(!currentRepostId) return
  
  const comment = document.getElementById('repost-comment').value.trim()
  
  const r = await fetch('/api/repost', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      nickname,
      post_id: currentRepostId,
      comment: comment || null
    })
  })
  
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  if(r.status === 429){
    const data = await r.json()
    alert(data.error || "Too many reposts, slow down!")
    return
  }
  if(!r.ok){
    alert("Error reposting. Try again.")
    return
  }
  
  closeRepostModal()
  alert("Reposted!")
  
  const btn = document.querySelector(`[data-post-id="${currentRepostId}"] button[onclick*="openRepostModal"]`)
  if(btn){
    const match = btn.textContent.match(/\d+/)
    const currentCount = match ? parseInt(match[0]) : 0
    btn.textContent = `repost (${currentCount + 1})`
  }
}

function createcommentdiv(c){
  const div=document.createElement("div")
  div.className="comment"
  div.innerHTML=`<span>@${c.nickname}: ${processContent(c.content)} Â· ${timeago(c.created_at)}</span>
                 <button onclick="showreply(${c.id},${c.post_id})">reply</button>
                 <div class="reply-box hidden" id="reply${c.id}">
                   <input maxlength="100" placeholder="reply">
                   <button onclick="sendreply(${c.post_id},${c.id})">send</button>
                 </div>`
  return div
}

async function load(){
  const url = `/api/posts?offset=${offset}&feed=${currentFeed}&nickname=${nickname}`
  const r=await fetch(url)
  const d=await r.json()
  const el=document.getElementById("posts")
  
  const factCheckMap = {}
  if (d.factChecks) {
    d.factChecks.forEach(fc => {
      factCheckMap[fc.post_id] = fc
    })
  }
  
  const repostMap = {}
  if (d.reposts) {
    d.reposts.forEach(rp => {
      repostMap[rp.original_post_id] = rp.count
    })
  }
  
  d.posts.forEach(p=>{
    const commentCount = d.comments.filter(c=>c.post_id===p.id).length
    const factCheck = factCheckMap[p.id]
    const repostCount = repostMap[p.id] || 0
    
    const div=document.createElement("div")
    div.className="post"
    div.dataset.postId=p.id
    
    let postHTML = `<div>${processContent(p.content)}</div>`
    
    if (factCheck) {
      postHTML += `<div class="fact-check-warning">
        <strong>fact check:</strong> ${escapeHtml(factCheck.admin_message)}
      </div>`
    }
    
    const escapedContent = p.content.replace(/'/g, "\\'").replace(/"/g, "&quot;")
    
    postHTML += `<div class="meta">
        <a href="/profile/${p.nickname}">@${p.nickname}</a>
        <span>${timeago(p.created_at)}</span>
        <span>score: <span id="score${p.id}">${p.score}</span></span>
        <button onclick="react(${p.id},1)">+</button>
        <button onclick="react(${p.id},-1)">-</button>
        <button onclick="togglecomments(${p.id})">comments (${commentCount})</button>
        <button onclick="openRepostModal(${p.id}, '${escapedContent}')">repost (${repostCount})</button>
        <div class="menu">
          <button class="dots" onclick="toggleMenu(${p.id})">â‹¯</button>
          <div id="menu${p.id}" class="dropdown">
            <button onclick="sharePost(${p.id})">Share Post</button>
            <button onclick="reportPost(${p.id}, '${p.nickname}')">Report Post</button>
            <button onclick="reportUser(${p.id}, '${p.nickname}')">Report User</button>
            <button onclick="reportBoth(${p.id}, '${p.nickname}')">Report Both</button>
          </div>
        </div>
      </div>
      <div id="comments${p.id}" class="hidden"></div>
      <div class="reply-box hidden" id="newcomment${p.id}">
        <input maxlength="100" placeholder="comment">
        <button onclick="sendcomment(${p.id})">send</button>
      </div>`
    
    div.innerHTML = postHTML
    
    const commentsdiv=div.querySelector("#comments"+p.id)
    d.comments.filter(c=>c.post_id===p.id&&!c.parent_id).forEach(c=>{
      commentsdiv.appendChild(createcommentdiv(c))
    })
    el.appendChild(div)
  })
  offset+=20
}

function togglecomments(id){
  document.getElementById("comments"+id).classList.toggle("hidden")
  document.getElementById("newcomment"+id).classList.toggle("hidden")
}

async function createpost(){
  const i=document.getElementById("postinput")
  if(!i.value.trim()) return
  const r=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,content:i.value})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  if(r.status === 429){
    const data = await r.json()
    alert(data.error || "Too many posts, slow down!")
    return
  }
  if(!r.ok){
    alert("Error posting. Try again.")
    return
  }
  const data=await r.json()
  i.value=""
  document.getElementById("posts").innerHTML=""
  offset=0
  load()
}

async function react(id,v){
  const r=await fetch("/api/react",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id:id,value:v})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  const data=await r.json()
  document.getElementById("score"+id).textContent=data.score
}

async function sendcomment(post_id){
  const input=document.querySelector(`#newcomment${post_id} input`)
  if(!input.value.trim()) return
  const r=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id,content:input.value})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  if(r.status === 429){
    const data = await r.json()
    alert(data.error || "Too many comments, slow down!")
    return
  }
  if(!r.ok){
    alert("Error commenting. Try again.")
    return
  }
  input.value=""
  const data=await r.json()
  const div=createcommentdiv({nickname,content:input.value,created_at:Date.now(),id:data.id,post_id})
  document.getElementById("comments"+post_id).appendChild(div)
  document.getElementById("comments"+post_id).classList.remove("hidden")
  
  const btn = document.querySelector(`[data-post-id="${post_id}"] button[onclick*="togglecomments"]`)
  if(btn){
    const currentCount = parseInt(btn.textContent.match(/\d+/)[0])
    btn.textContent = `comments (${currentCount + 1})`
  }
}

function showreply(comment_id,post_id){
  document.getElementById("reply"+comment_id).classList.toggle("hidden")
}

async function sendreply(post_id,parent_id){
  const input=document.querySelector(`#reply${parent_id} input`)
  if(!input.value.trim()) return
  const r=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname,post_id,content:input.value,parent_id})})
  if(r.status === 403){
    alert("You're banned!")
    location.href = '/banned'
    return
  }
  if(r.status === 429){
    const data = await r.json()
    alert(data.error || "Too many comments, slow down!")
    return
  }
  if(!r.ok){
    alert("Error replying. Try again.")
    return
  }
  const data=await r.json()
  const div=createcommentdiv({nickname,content:input.value,created_at:Date.now(),id:data.id,post_id})
  document.querySelector(`#comments${post_id}`).appendChild(div)
  input.value=""
  document.querySelector(`#comments${post_id}`).classList.remove("hidden")
  
  const btn = document.querySelector(`[data-post-id="${post_id}"] button[onclick*="togglecomments"]`)
  if(btn){
    const currentCount = parseInt(btn.textContent.match(/\d+/)[0])
    btn.textContent = `comments (${currentCount + 1})`
  }
}

async function deleteaccount(){
  if(!confirm("delete your account? this will remove all your posts, comments, and reactions. this cannot be undone.")) return
  const r=await fetch("/api/account/"+nickname,{method:"DELETE"})
  if(r.status===200){
    localStorage.removeItem("nickname")
    alert("account deleted")
    location.href="/"
  }else{
    alert("error deleting account")
  }
}

load()
</script>
</body>
</html>
